<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExApp-CL Portal</title>
    <style>
        /* --- DESIGN SPECIFICATION IMPLEMENTATION --- */
        
        /* Primary Background Color (Deep Sea Blue) */
        body {
            background-color: #1C2A39; /* Deep Sea Blue */
            color: white;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        /* Container for Centering Front Page */
        #frontPage {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            text-align: center;
            position: relative; /* IMPORTANT: Required for absolute positioning of copyright */
        }

        /* All Page Containers */
        .page {
            display: none; /* Hidden by default */
            width: 100%;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        
        /* --- START OF DATA ENTRY / ADMIN PANEL CENTERING FIX --- */
        #dataEntry, #adminPanel {
            /* Center the content block horizontally */
            display: flex;
            flex-direction: column;
            align-items: center; /* Centers items horizontally */
            text-align: center; /* Centers text/labels */
        }

        /* Container to structure the inputs and center them on the page */
        .page-content-wrapper {
            width: 90%;
            max-width: 600px; /* Constrain width for better centering */
            margin-top: 15px;
            text-align: left; /* Align labels/inputs within the wrapper */
        }
        
        /* Ensure Front Page login area is white */
        #login-area {
            background-color: #1C2A39;
            padding: 40px;
            border-radius: 4px;
            color: white;
            width: 300px;
            text-align: center;
        }

        /* Input and Button Styling */
        input[type="text"], input[type="password"], select, textarea {
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%; 
            box-sizing: border-box;
            background-color: white; /* **KEEP WHITE** */
            color: black;
        }
        
        /* Dropdowns/Selects in Data Entry Page - Ensure white background and black text */
        #dataEntry select, #adminPanel select, #adminPanel input[type="text"] {
            background-color: white;
            color: black;
            border: 1px solid #ccc;
        }
        
        /* Dropdown widths inside the wrapper */
        .page-content-wrapper select {
            width: 100%;
            display: block;
        }


        button, .view-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            margin: 10px 5px 0 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        /* Style for disabled buttons */
        button:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }

        .back-btn {
            background-color: #f44336;
            align-self: flex-start; /* Keeps the back button aligned left */
        }

        .admin-btn {
            background-color: #3b5998;
        }
        
        /* Sheet/Report Styles */
        #gradesSheet .sheet-content, #markSheet .sheet-content {
             background-color: white;
             color: black;
             padding: 20px;
             border-radius: 4px;
             max-width: none;
             width: 100%;
             box-sizing: border-box;
             overflow-x: auto; /* Allow horizontal scrolling for many subjects */
        }

        /* Enhanced styling for Mark/Grade sheets tables */
        #gradesTable, #marksTable {
            width: 100%;
            min-width: 800px; /* Ensure table is wide enough for good column display */
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 10pt;
        }
        #gradesTable th, #gradesTable td, #marksTable th, #marksTable td {
            border: 1px solid #ddd; /* Lighter border for sheet */
            padding: 8px;
            text-align: center; /* Center scores/grades in the sheets */
            color: black;
            white-space: nowrap; /* Prevent subject headers from wrapping */
        }
        #gradesTable th, #gradesTable th:nth-last-child(1), #marksTable th, #marksTable th:nth-last-child(1) {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        /* Explicitly left align Ex No and Name columns in sheets */
        #gradesTable td:nth-child(1), #gradesTable td:nth-child(2),
        #marksTable td:nth-child(1), #marksTable td:nth-child(2) {
            text-align: left;
        }
        #gradesTable th:nth-child(1), #gradesTable th:nth-child(2),
        #marksTable th:nth-child(1), #marksTable th:nth-child(2) {
            text-align: left;
        }

        /* --- LOGO FIX: Styling for actual image (Applied from previous correction) --- */
        .logo {
            /* Remove placeholder styling (background-color, text styles) */
            background-color: transparent !important;
            color: transparent !important;
            font-size: 0;
            
            /* Apply size and margin for front page */
            display: block; 
            width: 200px; 
            height: 100px;
            object-fit: contain; /* Ensure logo scales correctly without stretching */
            margin: 0 auto 10px auto; 
        }
        
        /* Override size for report header */
        #progressReport header .logo {
            width: 200px; 
            height: 100px;
            margin: 0 15px 0 0; /* Align left in flex header */
        }

        /* --- PROGRESS REPORT A4 SCREEN VIEW FIX & TOP MARGIN ADJUSTMENT --- */
        #progressReport {
            background-color: white;
            color: black;
            /* Increased top padding to push content down and equalize visual top/bottom border */
            padding: 100px 40px 40px 40px; 
            
            /* A4 Portrait size approximation at 96 DPI: 794px x 1123px */
            width: 794px; /* Fixed width for A4 simulation */
            min-height: 1123px; /* Minimum height for A4 simulation */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); /* Add shadow to look like a separate page */
            margin: 20px auto; /* Center the page horizontally on screen */
            
            page-break-after: always; /* Ensure one A4 page logic for print */
        }
        
        #progressReport header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        #reportHeaderRight {
            text-align: right;
            font-size: 9pt;
        }

        #reportHeaderRight h3 {
            font-size: 16pt;
            margin: 0 0 5px 0;
        }

        #reportDetails {
            margin: 15px 0;
            border-bottom: 1px solid black;
            padding-bottom: 10px;
        }

        #reportDetails div {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
        }

        #resultsTable {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 10pt;
        }

        #resultsTable th, #resultsTable td {
            border: 1px solid black;
            padding: 5px;
            text-align: left; /* Headers aligned left */
            background-color: white; /* Ensure table cells are white */
        }
        /* Center Grades in the Progress Report table (3rd column) */
        #resultsTable td:nth-child(3) {
            text-align: center;
        }
        /* Center Position in the Progress Report table (4th column) */
        #resultsTable td:nth-child(4) {
            text-align: center;
        }

        #resultsTable th {
            background-color: #eee; /* Light header for differentiation */
        }

        /* Styles for the Grade Key Table */
        #gradeKeyTable {
            width: 100%; /* Takes full width of its 48% container */
            border-collapse: collapse;
            font-size: 9pt;
            /* Ensure it has a border */
            border: 1px solid black; 
        }
        #gradeKeyTable th, #gradeKeyTable td {
            border: 1px solid black;
            padding: 3px 5px; /* Compact padding */
            text-align: center;
            background-color: white;
            vertical-align: middle;
        }
        #gradeKeyTable .range-header {
            text-align: center;
            font-weight: bold;
            background-color: #eee;
        }
        /* End NEW Styles */


        #reportSummary div {
            margin: 5px 0;
            font-weight: bold;
        }

        #reportComment {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid black;
            font-size: 10pt;
            height: 30px; /* Two lines height estimate */
            overflow: hidden;
            background-color: white;
        }

        .hidden {
            display: none !important;
        }

        /* --- NEW: COPYRIGHT STYLE FOR FRONT PAGE --- */
        #copyright {
            position: absolute; /* Fixes it relative to #frontPage (100vh) */
            bottom: 15px; /* Distance from the bottom */
            font-size: 0.75em;
            color: lightgray;
            width: 100%;
            text-align: center;
        }
        
        /* --- A4 PRINTING STYLES (REQUIRED to ensure A4 output) --- */
        @media print {
            /* Define the paper size and a common margin */
            @page {
                size: A4 portrait;
                margin: 1cm; /* Standard print margin */
            }
            
            /* Hide all pages except the Progress Report when printing */
            body > .page:not(#progressReport) {
                display: none !important;
            }
            
            /* Ensure the Progress Report takes the defined A4 space, removing fixed screen size */
            #progressReport {
                width: auto !important; 
                min-height: auto !important;
                margin: 0 !important; 
                /* Increased top padding for print to match the larger top margin requested */
                padding: 100px 40px 40px 40px !important; 
                box-shadow: none !important; 
                display: block !important;
            }
            
            /* Hide the back and print/save buttons in the print view */
            #progressReport .back-btn,
            #progressReport .view-btn {
                display: none !important;
            }
        }
    </style>
</head>
<body>

    <div id="frontPage" class="page" style="display: flex;">
        <div id="login-area">
            <img src="assets/logo.png" class="logo" alt="School Logo">
            <h2 style="margin-top: 5px;">MAGAWA SECONDARY SCHOOL</h2>
            <h3 style="margin-top: 3px;">Exam Department</h3>   
            <label for="username">Username:</label>
            <input type="text" id="username" placeholder="Enter username">
            
            <label for="password">Password:</label>
            <input type="password" id="password" placeholder="Enter password">
            
            <button onclick="login()">Login</button>
            <p id="loginMessage" style="color: red;"></p>
        </div>
        
        <div id="copyright">
            &copy; 2024 Magawa Secondary School.Designed by Chiku Lubaini. All rights reserved.
        </div>
        
    </div>

    <div id="dataEntry" class="page">
        <button class="back-btn" onclick="goToPage('frontPage')">Back</button>
        <h2 style="color: white;">📚 Data Entry / Report Selection</h2>
        
        <div class="page-content-wrapper">
            <label for="classSelect">Select Class for Data Entry/Viewing:</label>
            <select id="classSelect" onchange="updateStudentSelect()">
                <option value="Form1">Form 1</option>
                <option value="Form2">Form 2</option>
                <option value="Form3">Form 3</option>
                <option value="Form4">Form 4</option>
            </select>
            
            <label for="examNoSelect">Select Exam Number for Data Entry/Report:</label>
            <select id="examNoSelect" onchange="displayStudentName()">
                </select>
            
            <label>Student Name:</label>
            <input type="text" id="studentNameDisplay" readonly style="color: #444;">

            <hr style="border-top: 1px solid white; margin: 15px 0;">

            <h3>Score Entry</h3>
            <label for="subjectSelect">Select Subject:</label>
            <select id="subjectSelect">
                </select>
            
            <label for="scoreInput">Enter Score:</label>
            <input type="text" id="scoreInput" placeholder="Enter score (0-100)">
            
            <button onclick="submitScore()">Submit Score</button>
            <p id="scoreMessage" style="color: lightgreen; margin-top: 10px;"></p>
        </div>
        
        <div style="margin-top: 20px; text-align: center;">
            <p style="font-weight: bold; margin-bottom: 5px;">View Reports for Selected Class/Student:</p>
            <button class="view-btn" onclick="viewGradesSheet()">View Grade Sheet</button>
            <button class="view-btn" onclick="viewMarkSheet()">View Mark Sheet</button>
            <button class="view-btn" onclick="viewProgressReport()">View Progress Report</button>
        </div>
        
        <button class="admin-btn" style="margin-top: 30px;" onclick="showAdminPrompt()">Admin Button</button>
    </div>

    <div id="adminPanel" class="page">
        <button class="back-btn" onclick="goToPage('dataEntry')">Back</button>
        <h2 style="text-align: center; color: white;">⚙️ Manage Files & Settings</h2>
        
        <div class="page-content-wrapper">
            
            <h3>File Operations</h3>
            <label for="csvClassSelect">Select Class for CSV Upload:</label>
            <select id="csvClassSelect">
                <option value="Form1">Form 1</option>
                <option value="Form2">Form 2</option>
                <option value="Form3">Form 3</option>
                <option value="Form4">Form 4</option>
            </select>
            
            <label for="csvUpload" style="margin-top: 10px;">Upload CSV Files/Edit/Delete files:</label>
            <input type="file" id="csvUpload" accept=".csv" style="width: auto; margin-right: 10px; display: block;" onchange="toggleUploadButton()">
            
            <button id="uploadButton" onclick="handleCsvUpload()" disabled>Upload/Update Student List</button> 
            <p style="font-size: 0.9em;">(CSV files contain Exam Number and Student's Name)</p>
            
            <hr style="border-top: 1px solid white; margin: 15px 0;">
            
            <h3>Subject Teacher Assignment</h3>
    
            <label for="assignSubjectSelect">Select Subject to Assign:</label>
            <select id="assignSubjectSelect"></select> 
            
            <label for="assignTeacherInput">Enter Teacher's Name or Select from List:</label>
            <input 
                type="text" 
                id="assignTeacherInput" 
                list="teacherList" 
                placeholder="e.g., Mr. Banda or use clear"
            >
            <datalist id="teacherList">
                <option value="Mr. Banda">
                <option value="Ms. Chiume">
                <option value="--- CLEAR ASSIGNMENT ---">
            </datalist>
            
            <button onclick="assignTeacherToSubject()">Assign Teacher</button>
            <p id="assignmentMessage" style="color: lightgreen; margin-top: 10px;"></p>
            
            <div id="currentAssignments" style="margin-top: 10px; color: lightgray; text-align: center; font-size: 0.9em;">
                </div>

            <hr style="border-top: 1px solid white; margin: 15px 0;">
            
            <h3>Report Settings (Admin Panel)</h3>
            
            <label for="termSelect">Select Current Term:</label>
            <select id="termSelect">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
            </select>

            <label for="generalComment">COMMENT: (General comment for Progress Report, max 2 lines, font 10):</label>
            <textarea id="generalComment" rows="2" style="font-size: 10pt;" placeholder="Excellent term! Keep up the great work."></textarea>
            
            <button onclick="saveAdminSettings()">Save Settings</button>
        </div>
    </div>

    <div id="gradesSheet" class="page">
        <button class="back-btn" onclick="goToPage('dataEntry')">Back</button>
        <h2 style="color: white;">📄 Grades Sheet - <span id="gradesSheetClass"></span></h2>
        <div class="sheet-content">
            <button onclick="alert('Selecting...')">Select</button>
            <button onclick="alert('Copying...')">Copy</button>
            <button onclick="window.print()">Print</button>
            <button onclick="alert('Saving as PDF...')">Save as PDF</button>
            <button onclick="exportTableData('gradesTable', 'GradeSheet', 'csv')">Save as CSV</button>
            <button onclick="exportTableData('gradesTable', 'GradeSheet', 'excel')">Export Excel</button>
            
            <p style="color: black;">Grades Data (Alphabetical Subjects):</p>
            <table id="gradesTable">
                </table>
        </div>
    </div>

    <div id="markSheet" class="page">
        <button class="back-btn" onclick="goToPage('dataEntry')">Back</button>
        <h2 style="color: white;">📝 Mark Sheet - <span id="markSheetClass"></span></h2>
        <div class="sheet-content">
            <button onclick="alert('Selecting...')">Select</button>
            <button onclick="alert('Copying...')">Copy</button>
            <button onclick="window.print()">Print</button>
            <button onclick="alert('Saving as PDF...')">Save as PDF</button>
            <button onclick="exportTableData('marksTable', 'MarkSheet', 'csv')">Save as CSV</button>
            <button onclick="exportTableData('marksTable', 'MarkSheet', 'excel')">Export Excel</button>
            
            <p style="color: black;">Mark Data (Raw Scores - Alphabetical Subjects):</p>
            <table id="marksTable">
                </table>
        </div>
    </div>

    <div id="progressReport" class="page">
        <button class="back-btn" onclick="goToPage('dataEntry')" style="position: absolute; top: 10px; left: 10px;">Back</button>

        <header>
            <div style="display: flex; align-items: center;">
                <img src="assets/logo.png" class="logo" alt="School Logo">
            </div>
            <div id="reportHeaderRight">
                <h3>MAGAWA SECONDARY SCHOOL</h3>
                Private Bag 17,<br>
                Magawa,<br>
                Mchinji.
            </div>
        </header>
        
        <hr style="border-top: 2px solid black; margin: 10px 0;">
        
        <div style="margin-bottom: 10px;">
            <h2 style="margin: 0;">PROGRESS REPORT</h2>
        </div>
        
        <div id="reportDetails">
            <div>
                <p><strong>STUDENT NAME:</strong> <span id="reportStudentName"></span></p>
                <p><strong>Exam No:</strong> <span id="reportExamNo"></span></p>
            </div>
            <div>
                <p><strong>FORM:</strong> <span id="reportForm"></span></p>
                <p><strong>TERM:</strong> <span id="reportTerm">1</span></p> 
            </div>
        </div>
        
        <table id="resultsTable">
            <thead>
                <tr>
                    <th style="width: 20%;">SUBJECT</th>
                    <th style="width: 10%;">SCORE</th>
                    <th style="width: 10%;">GRADE</th>
                    <th style="width: 10%;">POSITION</th>
                    <th style="width: 30%;">REMARKS</th>
                    <th style="width: 20%;">TEACHER</th>
                </tr>
            </thead>
            <tbody id="reportBody">
                </tbody>
        </table>

        <div id="summaryAndKeyWrapper" style="display: flex; justify-content: space-between; margin-top: 20px;">
    
            <div id="reportSummary" style="width: 48%;">
                <div id="averageLine" class="hidden">Average: <span id="reportAverage"></span></div>
                <div id="aggregateLine" class="hidden">Aggregate: <span id="reportAggregate"></span></div>
                <div>Position in Class: <span id="reportPosition"></span></div>
                <div>Remark: <span id="reportOverallRemark"></span></div>
            </div>
            
            <div id="gradeKeyPlaceholder" style="width: 48%;">
                </div>

        </div>
        <p style="margin-top: 20px;"><strong>COMMENT:</strong></p>
        <div id="reportComment">
            </div>

        <div style="text-align: right; margin-top: 20px;">
            <button class="view-btn" onclick="window.print()" style="background: none; color: black; border: 1px solid black;">Print</button>
            <button class="view-btn" onclick="saveProgressReportAsPDF()" style="background: none; color: black; border: 1px solid black;">Save (PDF)</button>
        </div>
        <p style="text-align: center; font-size: 8pt; margin-top: 10px;">Progress of results covers one A4 page only.</p>
    </div>

<script>
    // --- MOCK DATABASE (In-Memory Storage) ---
    // This is the default list. It will be overwritten by a successful CSV upload.
    const MOCK_STUDENTS_BY_CLASS = {
        'Form1': {
            'Ex001': { name: 'Alice Mwale', Form: 'Form1', scores: {}, grades: {} },
            'Ex004': { name: 'David Jones', Form: 'Form1', scores: {}, grades: {} },
        },
        'Form2': {
            'Ex006': { name: 'Grace Phiri', Form: 'Form2', scores: {}, grades: {} },
        },
        'Form3': {
            'Ex002': { name: 'Brian Phiri', Form: 'Form3', scores: {}, grades: {} },
            'Ex005': { name: 'Faith Kanyemba', Form: 'Form3', scores: {}, grades: {} },
        },
        'Form4': {
            'Ex003': { name: 'Cathy Tembo', Form: 'Form4', scores: {}, grades: {} },
        }
    };

    const ALL_SUBJECTS = ["Agriculture", "Bible Knowledge", "Biology", "Chemistry", "Chichewa", "English", "Geography", "History", "Mathematics", "Physics", "Social/Life"];
    
    // Global storage for subject-teacher assignments
    let SUBJECT_TEACHERS = {};
    // Default teacher is a hyphen ('-')
    const DEFAULT_TEACHER = "-"; 

    let currentClass = 'Form1'; // Default
    let selectedExamNo = 'Ex001'; // Default
    
    // NEW GLOBAL: Store the selected term (Default to 1)
    let currentTerm = '1'; 


    // --- GRADING KEY DATA STRUCTURES ---
    const GRADE_KEY_F1_F2 = [
        { range: '80 - 100', grade: 'A', remark: 'Excellent' },
        { range: '65 - 79', grade: 'B', remark: 'Very Good' },
        { range: '55 - 64', grade: 'C', remark: 'Good' },
        { range: '40 - 54', grade: 'D', remark: 'Average' },
        { range: '0 - 39', grade: 'F', remark: 'Fail' },
    ];

    const GRADE_KEY_F3_F4 = [
        { range: '80 - 100', grade: '1-2', remark: 'Distinction' },
        { range: '70 - 79', grade: '3-4', remark: 'Strong Credit' },
        { range: '60 - 69', grade: '5-6', remark: 'Credit' },
        { range: '45 - 59', grade: '7-8', remark: 'Pass' },
        { range: '0 - 44', grade: '9', remark: 'Fail' },
    ];
    // --- END GRADING KEY DATA STRUCTURES ---


    // --- UTILITY FUNCTIONS ---

    function getStudent(examNo) {
        for (const className in MOCK_STUDENTS_BY_CLASS) {
            if (MOCK_STUDENTS_BY_CLASS[className][examNo]) {
                return MOCK_STUDENTS_BY_CLASS[className][examNo];
            }
        }
        return null;
    }

    // Helper to get a consistent numeric grade for sorting (lower is better)
    function getNumericGradeForSorting(form, grade) {
        if (grade === 'X' || grade === '-') return 100; // Arbitrarily high for sorting down

        if (form === 'Form1' || form === 'Form2') {
            // Map F1/F2 grades to a numeric value for comparison/sorting (Lower is better)
            if (grade === 'A') return 1;
            if (grade === 'B') return 4; 
            if (grade === 'C') return 6; 
            if (grade === 'D') return 8; 
            if (grade === 'F') return 9;
        }

        // Forms 3/4 grades are already numeric 1-9
        const numeric = parseInt(grade);
        if (!isNaN(numeric) && numeric >= 1 && numeric <= 9) {
            return numeric;
        }
        return 100;
    }


    // --- GRADING FUNCTIONS (Unchanged) ---

    function getGradeAndRemark(form, score) {
        if (score === null || score === undefined || score === '') return { grade: '-', remark: 'No score' };
        
        const scoreInput = String(score).toUpperCase();
        
        if (scoreInput === 'X') return { grade: 'X', remark: 'No score' };

        score = parseInt(scoreInput);

        // Forms 1 and 2 Grading
        if (form === 'Form1' || form === 'Form2') {
            if (score >= 80) return { grade: 'A', remark: 'Excellent' };
            if (score >= 65) return { grade: 'B', remark: 'Very Good' };
            if (score >= 55) return { grade: 'C', remark: 'Good' };
            if (score >= 40) return { grade: 'D', remark: 'Average' };
            return { grade: 'F', remark: 'Fail' };
        }

        // Forms 3 and 4 Grading (MSCE)
        if (form === 'Form3' || form === 'Form4') {
            if (score >= 80) return { grade: '1', remark: 'Distinction' };
            if (score >= 75) return { grade: '2', remark: 'Distinction' };
            if (score >= 70) return { grade: '3', remark: 'Strong Credit' };
            if (score >= 65) return { grade: '4', remark: 'Strong Credit' };
            if (score >= 60) return { grade: '5', remark: 'Credit' };
            if (score >= 55) return { grade: '6', remark: 'Credit' };
            if (score >= 45) return { grade: '7', remark: 'Pass' };
            if (score >= 35) return { grade: '8', remark: 'Pass' };
            return { grade: '9', remark: 'Fail' };
        }
        return { grade: 'X', remark: 'Error' };
    }

    function isPassingGrade(form, grade) {
        if (form === 'Form1' || form === 'Form2') {
            return ['A', 'B', 'C', 'D'].includes(grade);
        }
        if (form === 'Form3' || form === 'Form4') {
            return ['1', '2', '3', '4', '5', '6', '7', '8'].includes(grade);
        }
        return false;
    }

    // --- NAVIGATION AND INITIALIZATION (Unchanged) ---

    function goToPage(pageId) {
        document.querySelectorAll('.page').forEach(page => page.style.display = 'none');
        
        const targetPage = document.getElementById(pageId);
        if (targetPage) {
            if (pageId === 'frontPage' || pageId === 'dataEntry' || pageId === 'adminPanel') {
                targetPage.style.display = 'flex'; 
            } else {
                targetPage.style.display = 'block';
            }
        }
    }

    function init() {
        // Populate Subject Dropdown (Data Entry)
        const subjectSelect = document.getElementById('subjectSelect');
        const subjectsHtml = ALL_SUBJECTS.map(sub => `<option value="${sub}">${sub}</option>`).join('');
        subjectSelect.innerHTML = subjectsHtml;
        
        // Populate Subject Dropdown (Admin Panel)
        const assignSubjectSelect = document.getElementById('assignSubjectSelect');
        if (assignSubjectSelect) {
            assignSubjectSelect.innerHTML = subjectsHtml;
        }

        // Set up initial selectors
        document.getElementById('classSelect').addEventListener('change', updateStudentSelect);
        document.getElementById('examNoSelect').addEventListener('change', displayStudentName);

        // Initial population
        updateStudentSelect(); 
        goToPage('frontPage');
        
        // Initialize Admin Assignments Display
        updateAssignmentsDisplay();
        
        // Set the Term selector to the current term on load
        document.getElementById('reportTerm').textContent = currentTerm;
        const termSelect = document.getElementById('termSelect');
        if (termSelect) {
            termSelect.value = currentTerm;
        }
    }
    
    // Updates the Exam Number dropdown based on the selected class
    function updateStudentSelect() {
        const classSelect = document.getElementById('classSelect');
        const examNoSelect = document.getElementById('examNoSelect');
        currentClass = classSelect.value;
        
        const studentsInClass = MOCK_STUDENTS_BY_CLASS[currentClass] || {};
        
        examNoSelect.innerHTML = '';
        const examNumbers = Object.keys(studentsInClass);
        
        if (examNumbers.length > 0) {
            examNumbers.forEach(examNo => {
                const student = studentsInClass[examNo];
                const option = document.createElement('option');
                option.value = examNo;
                // Only display the Exam Number
                option.textContent = `${examNo}`; 
                examNoSelect.appendChild(option);
            });
            selectedExamNo = examNumbers[0];
        } else {
            examNoSelect.innerHTML = '<option value="">No Students</option>';
            selectedExamNo = null;
        }

        displayStudentName();
    }

    // --- FRONT PAGE LOGIC (Unchanged) ---

    function login() {
        const password = document.getElementById('password').value;
        const msg = document.getElementById('loginMessage');
        
        if (password === '001') {
             msg.textContent = 'Use the Admin Button from the Data Entry page.';
             msg.style.color = 'red';
             return;
        }

        if (password === '') {
            msg.textContent = 'Please enter credentials.';
            msg.style.color = 'red';
            return;
        }
        
        msg.textContent = '';
        goToPage('dataEntry'); 
    }

    // --- DATA ENTRY LOGIC (Unchanged) ---

    function displayStudentName() {
        selectedExamNo = document.getElementById('examNoSelect').value;
        const student = getStudent(selectedExamNo);
        document.getElementById('studentNameDisplay').value = student ? student.name : 'N/A';
    }

    function submitScore() {
        const examNo = document.getElementById('examNoSelect').value;
        const student = getStudent(examNo);
        const subject = document.getElementById('subjectSelect').value;
        const scoreInput = document.getElementById('scoreInput').value.toUpperCase();
        const msg = document.getElementById('scoreMessage');
        const form = student ? student.Form : null;

        if (!student) {
            msg.textContent = 'Please select a student.';
            msg.style.color = 'red';
            return;
        }

        let score, grade, remark;
        
        if (scoreInput === 'X') {
            score = 'X';
            grade = 'X';
            remark = 'No score';
        } else if (scoreInput === '' || scoreInput === '-') {
            score = null;
            grade = '-';
            remark = 'No score';
        } else {
            score = parseInt(scoreInput);
            if (isNaN(score) || score < 0 || score > 100) {
                msg.textContent = 'Invalid score. Must be 0-100, X, or left blank.';
                msg.style.color = 'red';
                return;
            }
            const result = getGradeAndRemark(form, score);
            grade = result.grade;
            remark = result.remark;
        }

        student.scores[subject] = score;
        student.grades[subject] = grade;

        msg.textContent = `Score of ${scoreInput} (${grade}) submitted for ${student.name} in ${subject}.`;
        msg.style.color = 'lightgreen';
        
        document.getElementById('scoreInput').value = ''; 
    }
    
    // --- ADMIN PANEL LOGIC (CSV UPLOAD FIX AND REFACTOR) ---
    
    /**
     * Checks if a file is selected and toggles the upload button's enabled state.
     */
    function toggleUploadButton() {
        const fileInput = document.getElementById('csvUpload');
        const uploadButton = document.getElementById('uploadButton');
        const msg = document.getElementById('assignmentMessage'); 

        if (fileInput.files.length > 0) {
            uploadButton.disabled = false;
            msg.textContent = `File ready: ${fileInput.files[0].name}. Click 'Upload' to process.`;
            msg.style.color = 'yellow';
        } else {
            uploadButton.disabled = true;
            msg.textContent = 'Select a CSV file to enable the upload button.';
            msg.style.color = 'lightgray';
        }
    }


    /**
     * Handles the CSV file upload from the Admin Panel, parses the student list,
     * and updates the MOCK_STUDENTS_BY_CLASS for the selected class.
     */
    function handleCsvUpload() {
        const classSelect = document.getElementById('csvClassSelect');
        const fileInput = document.getElementById('csvUpload');
        const msg = document.getElementById('assignmentMessage'); 
        const selectedClass = classSelect.value;
        const file = fileInput.files[0];

        // The button should be disabled if no file is selected, but this is a final check.
        if (!file) {
            msg.textContent = 'ERROR: No file selected. Please choose a CSV file first.';
            msg.style.color = 'red';
            document.getElementById('uploadButton').disabled = true;
            return;
        }

        if (file.type && file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
             msg.textContent = 'Invalid file type. Please upload a .csv file.';
             msg.style.color = 'red';
             return;
        }

        const reader = new FileReader();

        reader.onload = function(e) {
            const content = e.target.result;
            
            // Assuming the CSV format is: "Exam Number,Student Name" followed by data lines
            const lines = content.trim().split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) {
                msg.textContent = 'CSV file is empty or malformed.';
                msg.style.color = 'red';
                return;
            }

            // Simple header parsing (case insensitive, space agnostic)
            const header = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/\s/g, ''));
            const examNoIndex = header.indexOf('examnumber');
            const nameIndex = header.indexOf('studentname');

            if (examNoIndex === -1 || nameIndex === -1) {
                msg.textContent = 'CSV missing "Exam Number" or "Student Name" header.';
                msg.style.color = 'red';
                return;
            }

            // Clear existing students for the selected class before adding new ones
            MOCK_STUDENTS_BY_CLASS[selectedClass] = {};
            let count = 0;

            for (let i = 1; i < lines.length; i++) {
                // Handle potential commas within student names by only splitting on the first line
                // For simplicity, we assume no quotes and exactly 2 columns in all lines.
                const values = lines[i].split(',');
                if (values.length > 1) {
                    const examNo = values[examNoIndex].trim();
                    const studentName = values[nameIndex].trim();
                    
                    if (examNo && studentName) {
                        // Add or overwrite student data, preserving form data
                        MOCK_STUDENTS_BY_CLASS[selectedClass][examNo] = { 
                            name: studentName, 
                            Form: selectedClass, 
                            scores: {}, 
                            grades: {} 
                        };
                        count++;
                    }
                }
            }

            // IMPORTANT: Update all selectors on the data entry page
            updateStudentSelect();
            
            msg.textContent = `Successfully uploaded and added ${count} students to ${selectedClass}.`;
            msg.style.color = 'lightgreen';
            fileInput.value = ''; // Clear file input after successful upload
            toggleUploadButton(); // Reset the button to disabled state
        };

        reader.onerror = function() {
            msg.textContent = 'Error reading file.';
            msg.style.color = 'red';
        };

        reader.readAsText(file);
    }

    function showAdminPrompt() {
        const password = prompt("Enter Admin Password (001):");
        if (password === '001') {
            goToPage('adminPanel');
            // Ensure button state is checked immediately upon entering the panel
            toggleUploadButton(); 
        } else if (password !== null) {
            alert('Incorrect password.');
        }
    }
    
    function updateAssignmentsDisplay() {
        const displayDiv = document.getElementById('currentAssignments');
        if (!displayDiv) return;

        let html = '<strong>Current Assignments:</strong><br>';
        let assignmentsFound = false;
        
        const sortedSubjects = ALL_SUBJECTS.sort(); 
        
        sortedSubjects.forEach(subject => {
            const teacher = SUBJECT_TEACHERS[subject];
            if (teacher) {
                html += `${subject}: ${teacher}<br>`;
                assignmentsFound = true;
            }
        });

        if (!assignmentsFound) {
            html += `No specific subject teachers assigned. Default report value is '${DEFAULT_TEACHER}'.`; 
        }
        
        displayDiv.innerHTML = html;
    }

    function assignTeacherToSubject() {
        const subject = document.getElementById('assignSubjectSelect').value;
        // MODIFIED: Get value from the text input
        const teacherInput = document.getElementById('assignTeacherInput').value.trim();
        const msg = document.getElementById('assignmentMessage');

        if (teacherInput === '--- CLEAR ASSIGNMENT ---' || teacherInput === '') {
            delete SUBJECT_TEACHERS[subject];
            msg.textContent = `${subject} assignment cleared.`;
        } else {
            SUBJECT_TEACHERS[subject] = teacherInput;
            msg.textContent = `${teacherInput} assigned to ${subject}.`;
        }
        
        updateAssignmentsDisplay();
        msg.style.color = 'lightgreen';
        document.getElementById('assignTeacherInput').value = ''; // Clear input after submission
    }
    
    // NEW FUNCTION: Save Admin settings (Term and Comment)
    function saveAdminSettings() {
        // Save the selected term
        const termSelect = document.getElementById('termSelect');
        if (termSelect) {
            currentTerm = termSelect.value;
            // Update the display immediately if they view a report without reloading
            const reportTermSpan = document.getElementById('reportTerm');
            if (reportTermSpan) {
                reportTermSpan.textContent = currentTerm;
            }
        }
        
        // Comment saving (optional, just to keep the original logic)
        // const generalComment = document.getElementById('generalComment').value; 
        
        alert('Settings saved!');
    }


    // --- EXPORT FUNCTIONS (Unchanged) ---

    function exportTableData(tableId, filenamePrefix, type) {
        const table = document.getElementById(tableId);
        if (!table || table.rows.length <= 1) {
            alert(filenamePrefix.includes("MarkSheet") ? 'Mark Sheet is empty.' : 'Grade Sheet is empty.');
            return;
        }

        const selectedClass = document.getElementById('classSelect').value;
        const filename = `${filenamePrefix}_${selectedClass}`;
        
        let csv = [];
        const delimiter = ','; // Using comma for standard CSV export

        // 1. Get Headers (all <th> elements)
        const headers = Array.from(table.tHead.rows[0].cells).map(cell => cell.textContent.trim());
        csv.push(headers.join(delimiter));

        // 2. Get Data Rows (all <td> elements in tbody)
        Array.from(table.tBodies[0].rows).forEach(row => {
            const rowData = Array.from(row.cells).map(cell => {
                let text = cell.textContent.trim();
                // Basic CSV escaping: escape quotes and wrap in quotes if the text contains the delimiter
                if (text.includes(delimiter) || text.includes('"') || text.includes('\n')) {
                    text = `"${text.replace(/"/g, '""')}"`;
                }
                return text;
            });
            csv.push(rowData.join(delimiter));
        });

        const csvString = csv.join('\n');
        
        // 3. Trigger Download
        let mimeType, fileExtension;
        if (type === 'csv') {
            mimeType = 'text/csv;charset=utf-8;';
            fileExtension = 'csv';
        } else if (type === 'excel') { 
            // Using application/vnd.ms-excel with .xls extension often forces Excel to open it correctly
            mimeType = 'application/vnd.ms-excel;charset=utf-8;'; 
            fileExtension = 'xls'; 
        } else {
            return;
        }

        // Use encodeURIComponent for robustness
        const encodedUri = encodeURIComponent(csvString);
        const link = document.createElement("a");
        
        // Data URI format for download
        link.setAttribute("href", 'data:' + mimeType + ',' + encodedUri);
        link.setAttribute("download", `${filename}.${fileExtension}`);
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        alert(`Exported ${filenamePrefix} as ${filename}.${fileExtension}!`);
    }

    // --- SHEET VIEW LOGIC (Corrected to calculate Average/Aggregate and use hyphen) ---

    function viewGradesSheet() {
        const selectedClass = document.getElementById('classSelect').value;
        const studentsInClass = MOCK_STUDENTS_BY_CLASS[selectedClass] || {};
        const MIN_SUBJECTS = 6; 

        document.getElementById('gradesSheetClass').textContent = selectedClass;
        
        const isUpperForm = (selectedClass === 'Form3' || selectedClass === 'Form4');
        const finalColumnHeader = isUpperForm ? 'Aggregate' : 'Average';

        const table = document.getElementById('gradesTable');
        table.innerHTML = ''; 
        const thead = table.createTHead();
        const headerRow = thead.insertRow();
        
        headerRow.insertCell().textContent = 'Ex No';
        headerRow.insertCell().textContent = 'Name';
        
        ALL_SUBJECTS.forEach(subject => {
            headerRow.insertCell().textContent = subject;
        });
        
        headerRow.insertCell().textContent = finalColumnHeader;

        const tbody = table.createTBody();
        
        Object.keys(studentsInClass).forEach(examNo => {
            const student = studentsInClass[examNo];
            const row = tbody.insertRow();
            row.insertCell().textContent = examNo;
            row.insertCell().textContent = student.name;

            let subjectsCounted = 0;
            let totalScore = 0;
            let gradesList = [];
            
            ALL_SUBJECTS.forEach(subject => {
                const score = student.scores[subject];
                const grade = student.grades[subject] || '-';
                row.insertCell().textContent = grade;
                
                if (typeof score === 'number' && score >= 0 && score <= 100) {
                    subjectsCounted++;
                    totalScore += score;
                    if (isUpperForm) {
                         const numericGrade = getNumericGradeForSorting(student.Form, grade);
                         gradesList.push({ grade: grade, subject: subject, numericGrade: numericGrade });
                    }
                }
            });
            
            let metricDisplay = '-'; // Default to hyphen

            if (subjectsCounted >= MIN_SUBJECTS) {
                if (!isUpperForm) {
                    // Forms 1/2: Average 
                    metricDisplay = (totalScore / subjectsCounted).toFixed(2);
                } else {
                    // Forms 3/4: Aggregate 
                    gradesList.sort((a, b) => a.numericGrade - b.numericGrade);
                    const englishGradeEntry = gradesList.find(g => g.subject === 'English');

                    if (englishGradeEntry && isPassingGrade(student.Form, englishGradeEntry.grade)) {
                        let bestSixGrades = gradesList.slice(0, 6);
                        
                        // Ensure English is in the top 6 if passed
                        if (!bestSixGrades.some(g => g.subject === 'English')) {
                            const worstOfBestIndex = 5; 
                            bestSixGrades[worstOfBestIndex] = englishGradeEntry;
                            bestSixGrades.sort((a, b) => a.numericGrade - b.numericGrade); 
                        }
                        
                        // Recalculate best six after potential English insertion
                        const finalBestSix = bestSixGrades.slice(0, 6);
                        
                        metricDisplay = finalBestSix.reduce((sum, g) => sum + g.numericGrade, 0);
                    } else {
                        // English failed or not taken, or other ranking criteria not met: put hyphen
                        metricDisplay = '-'; 
                    }
                }
            } 

            row.insertCell().textContent = metricDisplay; 
        });

        goToPage('gradesSheet');
    }


    function viewMarkSheet() {
        const selectedClass = document.getElementById('classSelect').value;
        const studentsInClass = MOCK_STUDENTS_BY_CLASS[selectedClass] || {};
        
        document.getElementById('markSheetClass').textContent = selectedClass;

        const table = document.getElementById('marksTable');
        table.innerHTML = ''; 
        const thead = table.createTHead();
        const headerRow = thead.insertRow();
        
        headerRow.insertCell().textContent = 'Ex No';
        headerRow.insertCell().textContent = 'Name';
        
        ALL_SUBJECTS.forEach(subject => {
            headerRow.insertCell().textContent = subject;
        });

        const tbody = table.createTBody();
        
        Object.keys(studentsInClass).forEach(examNo => {
            const student = studentsInClass[examNo];
            const row = tbody.insertRow();
            row.insertCell().textContent = examNo;
            row.insertCell().textContent = student.name;

            ALL_SUBJECTS.forEach(subject => {
                const score = student.scores[subject] || '-';
                row.insertCell().textContent = score;
            });
        });

        goToPage('markSheet');
    }
    
    // --- RANKING LOGIC FUNCTIONS (Implementation added for functional Progress Report) ---

    /**
     * Calculates a student's rank for a specific subject (competition ranking).
     */
    function calculateSubjectRank(className, subject, targetScore) {
        if (targetScore === null || targetScore === undefined || targetScore === 'X' || typeof targetScore !== 'number') {
            return { rank: '-', totalStudents: 0 };
        }

        const studentsInClass = MOCK_STUDENTS_BY_CLASS[className] || {};
        const scores = [];

        // 1. Collect all valid scores for the subject in the class
        Object.keys(studentsInClass).forEach(examNo => {
            const student = studentsInClass[examNo];
            const score = student.scores[subject];
            if (typeof score === 'number' && score >= 0 && score <= 100) {
                scores.push(score);
            }
        });

        const totalStudents = scores.length;
        if (totalStudents === 0) {
            return { rank: '-', totalStudents: 0 };
        }
        
        // 2. Sort scores in descending order
        scores.sort((a, b) => b - a);
        
        // 3. Find the rank (competition ranking: 1, 1, 1, 4, 5...)
        let rank = 1;
        for (let i = 0; i < totalStudents; i++) {
            // Update rank only if the score is lower than the previous one
            if (i > 0 && scores[i] < scores[i-1]) {
                rank = i + 1;
            }
            
            // If the current score matches the target score, this is the rank.
            if (scores[i] === targetScore) {
                return { rank: rank, totalStudents: totalStudents };
            }
        }
        
        return { rank: '-', totalStudents: totalStudents }; 
    }

    /**
     * Calculates a student's overall class rank (competition ranking) based on Average/Aggregate.
     */
    function calculateOverallClassRank(className, targetExamNo) {
        const studentsInClass = MOCK_STUDENTS_BY_CLASS[className] || {};
        const classMetrics = [];
        const isUpperForm = (className === 'Form3' || className === 'Form4');
        const MIN_SUBJECTS = 6; 

        // 1. Calculate the ranking metric (Average or Aggregate) for all students
        Object.keys(studentsInClass).forEach(examNo => {
            const student = studentsInClass[examNo];
            let totalScore = 0;
            let subjectsCounted = 0;
            let gradesList = [];
            let metric = null; // null means not rankable 

            ALL_SUBJECTS.forEach(subject => {
                const score = student.scores[subject];
                if (typeof score === 'number' && score >= 0 && score <= 100) {
                    subjectsCounted++;
                    if (!isUpperForm) {
                        totalScore += score;
                    } else {
                        const { grade } = getGradeAndRemark(student.Form, score);
                        const numericGrade = getNumericGradeForSorting(student.Form, grade);
                        gradesList.push({ grade: grade, subject: subject, numericGrade: numericGrade });
                    }
                }
            });

            if (subjectsCounted >= MIN_SUBJECTS) {
                if (!isUpperForm) {
                    // Forms 1/2: Average (Higher is better)
                    metric = totalScore / subjectsCounted;
                } else {
                    // Forms 3/4: Aggregate (Lower is better)
                    gradesList.sort((a, b) => a.numericGrade - b.numericGrade);
                    const englishGradeEntry = gradesList.find(g => g.subject === 'English');
                    
                    if (englishGradeEntry && isPassingGrade(student.Form, englishGradeEntry.grade)) {
                        
                        let bestSixGrades = gradesList.slice(0, 6);
                        
                        // Ensure English is considered if passed
                        if (!bestSixGrades.some(g => g.subject === 'English')) {
                            const worstOfBestIndex = 5; 
                            bestSixGrades[worstOfBestIndex] = englishGradeEntry;
                            bestSixGrades.sort((a, b) => a.numericGrade - b.numericScore); 
                        }

                        // Take the sum of the top 6 numeric grades for aggregate
                        aggregateValue = bestSixGrades.slice(0, 6).reduce((sum, g) => sum + g.numericGrade, 0);
                        metric = aggregateValue; 
                    }
                }
            }
            
            classMetrics.push({ examNo: examNo, metric: metric });
        });

        // 2. Sort the metrics for ranking
        classMetrics.sort((a, b) => {
            // Null metrics go to the end (not rankable)
            if (a.metric === null && b.metric === null) return 0;
            if (a.metric === null) return 1; 
            if (b.metric === null) return -1; 
            
            if (isUpperForm) {
                return a.metric - b.metric; // Aggregate: Lower is better (ascending)
            } else {
                return b.metric - a.metric; // Average: Higher is better (descending)
            }
        });

        // 3. Find the student's rank 
        let rank = 1;
        let totalRankableStudents = classMetrics.filter(m => m.metric !== null).length;
        
        for (let i = 0; i < totalRankableStudents; i++) {
            const studentMetricEntry = classMetrics[i];
            
            const isDifferent = isUpperForm 
                ? (i > 0 && classMetrics[i].metric > classMetrics[i - 1].metric) 
                : (i > 0 && classMetrics[i].metric < classMetrics[i - 1].metric); 
            
            if (isDifferent) {
                 rank = i + 1;
            }

            if (studentMetricEntry.examNo === targetExamNo) {
                if (studentMetricEntry.metric === null) {
                    return { rank: 'N/A', totalStudents: totalRankableStudents };
                }
                return { rank: rank, totalStudents: totalRankableStudents };
            }
        }
        
        return { rank: 'N/A', totalStudents: totalRankableStudents }; 
    }


    // --- PROGRESS REPORT LOGIC (Updated to use functional ranking) ---

    function saveProgressReportAsPDF() {
        const examNo = document.getElementById('examNoSelect').value;
        const student = getStudent(examNo);
        
        if (!student) {
            alert('Please select a student first.');
            return;
        }
        
        // 1. Construct the desired filename/title
        const originalTitle = document.title;
        // Clean up the name for file use (simple replacement of spaces with underscores)
        const studentName = student.name.replace(/\s+/g, '_');
        // MODIFIED: Include term in the filename
        const newTitle = `Progress_Report_Term${currentTerm}_${student.Form}_${studentName}_${examNo}`;

        // 2. Temporarily change the document title
        document.title = newTitle;

        // 3. Trigger the browser's print/save dialog
        window.print();
        
        // 4. Restore the original title immediately
        setTimeout(() => {
            document.title = originalTitle;
        }, 100); 

        // Also display the alert (optional, since print dialog is already opened)
        alert('Saving as PDF...');
    }


    function viewProgressReport() {
        const classSelected = document.getElementById('classSelect').value;
        const examNo = document.getElementById('examNoSelect').value;
        const student = getStudent(examNo);
        
        if (!student || student.Form !== classSelected) {
            alert(`Please select a valid Exam Number for ${classSelected} to generate the progress report.`);
            return;
        }

        const form = student.Form;
        const MIN_SUBJECTS = 6; 

        // 1. Update Student Details
        document.getElementById('reportStudentName').textContent = student.name;
        document.getElementById('reportExamNo').textContent = examNo;
        document.getElementById('reportForm').textContent = form.replace('Form', '');
        // MODIFIED: Use the currentTerm variable
        document.getElementById('reportTerm').textContent = currentTerm;
        
        // 2. Populate Results Table
        const tbody = document.getElementById('reportBody');
        tbody.innerHTML = '';

        let totalScore = 0;
        let subjectsCounted = 0;
        let passingSubjects = 0;
        let englishPassed = false;
        let gradesList = [];
        
        // The value of generalComment is dynamic from the Admin Panel's textarea
        const generalComment = document.getElementById('generalComment').value || 'No comment entered by teacher.';

        ALL_SUBJECTS.forEach(subject => {
            const row = tbody.insertRow();
            const score = student.scores[subject];
            const { grade, remark } = getGradeAndRemark(form, score);
            
            let displayScore = (score === null || score === undefined) ? '-' : score;
            if (displayScore === 'X') displayScore = 'X';

            if (typeof score === 'number' && score >= 0 && score <= 100) {
                totalScore += score;
                subjectsCounted++;
                
                const numericGrade = getNumericGradeForSorting(form, grade);
                gradesList.push({ grade: grade, subject: subject, numericGrade: numericGrade });

                if (isPassingGrade(form, grade)) {
                    passingSubjects++;
                }
                if (subject === 'English' && isPassingGrade(form, grade)) {
                    englishPassed = true;
                }
            }
            
            // Get the assigned teacher for the subject, or use the hyphen default
            const subjectTeacher = SUBJECT_TEACHERS[subject] || DEFAULT_TEACHER; 

            // Calculate Subject Position
            let positionContent;
            if (typeof score === 'number' && score >= 0 && score <= 100) {
                const { rank, totalStudents } = calculateSubjectRank(form, subject, score);
                // Position is shown as Rank/Total_Students_Ranked
                positionContent = `${rank}/${totalStudents}`;
            } else {
                positionContent = '-';
            }

            row.insertCell().textContent = subject;
            row.insertCell().textContent = displayScore;
            row.insertCell().textContent = grade;
            // Display calculated subject rank/total
            row.insertCell().textContent = positionContent; 
            row.insertCell().textContent = remark;
            row.insertCell().textContent = subjectTeacher; 

        });
        
        // 3. Calculate Summary (Average/Aggregate) 
        
        let averageValue = '-'; // Changed from 'N/A' to '-'
        let aggregateValue = '-'; // Changed from 'N/A' to '-'
        const isUpperForm = (form === 'Form3' || form === 'Form4');

        if (subjectsCounted >= MIN_SUBJECTS) {
            if (!isUpperForm) {
                averageValue = (totalScore / subjectsCounted).toFixed(2);
            }
            
            if (isUpperForm) {
                gradesList.sort((a, b) => a.numericGrade - b.numericGrade);
                const englishGradeEntry = gradesList.find(g => g.subject === 'English');
                
                if (englishGradeEntry && isPassingGrade(form, englishGradeEntry.grade)) { 
                    
                    let bestSixGrades = gradesList.slice(0, 6);
                    
                    if (!bestSixGrades.some(g => g.subject === 'English')) {
                        const worstOfBestIndex = 5; 
                        bestSixGrades[worstOfBestIndex] = englishGradeEntry;
                        bestSixGrades.sort((a, b) => a.numericGrade - b.numericGrade); 
                    }

                    aggregateValue = bestSixGrades.slice(0, 6).reduce((sum, g) => sum + g.numericGrade, 0);
                } else {
                    aggregateValue = '-';
                }
            }
        } 


        document.getElementById('reportAverage').textContent = averageValue;
        document.getElementById('reportAggregate').textContent = aggregateValue;
        
        // 4. Handle Visibility (Average vs Aggregate)
        document.getElementById('averageLine').classList.toggle('hidden', isUpperForm);
        document.getElementById('aggregateLine').classList.toggle('hidden', !isUpperForm);

        // 5. Overall Remark
        let overallRemark = 'Fail';
        if (passingSubjects >= MIN_SUBJECTS && englishPassed) {
             overallRemark = 'Pass';
        }
        document.getElementById('reportOverallRemark').textContent = overallRemark;
        
        // CORRECTED: Calculate and display the actual Overall Class Position (Rank/Total)
        const { rank: overallRank, totalStudents: totalRankableStudents } = calculateOverallClassRank(classSelected, examNo);
        document.getElementById('reportPosition').textContent = `${overallRank}/${totalRankableStudents}`;

        // 6. Comment
        document.getElementById('reportComment').textContent = generalComment;


        // 7. NEW: Generate and insert Grade Key Table
        const gradeKeyData = isUpperForm ? GRADE_KEY_F3_F4 : GRADE_KEY_F1_F2;
        
        let keyHtml = `
            <table id="gradeKeyTable">
                <thead>
                    <tr>
                        <th colspan="2" class="range-header">RANGE</th>
                        <th>GRADE</th>
                        <th>COMMENT</th>
                    </tr>
                </thead>
                <tbody>`;
        
        // Generate the 5 rows of grading data
        gradeKeyData.forEach(item => {
            keyHtml += `
                <tr>
                    <td colspan="2">${item.range}</td>
                    <td>${item.grade}</td>
                    <td>${item.remark}</td>
                </tr>`;
        });
        
        keyHtml += `</tbody></table>`;
        
        // Insert the HTML into the placeholder
        document.getElementById('gradeKeyPlaceholder').innerHTML = keyHtml;

        goToPage('progressReport');
    }

    // Initialize the application when the page loads
    window.onload = init;
</script>

</body>
</html>